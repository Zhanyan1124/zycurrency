{% extends 'sidebar.html' %} {% block content %}
<div class="container-fluid">
  <h3 class="text-center" style="margin-bottom: 25px">
    Historical Relative Strength Index (RSI) Changes
  </h3>
  <div class="d-flex justify-content-center align-items-center">
    <div style="width: 70%">
      <form
        method="POST"
        action="/currency/historical-rsi"
        id="get_historical_form"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_rsi_token }}">
        <div
          class="row justify-content-between align-items-center"
          style="margin-bottom: 30px"
        >
          <div class="form-group col-4 mx-auto" style="margin-bottom: 25px">
            <label for="from_cur" class="form-label">From Currency </label>
            <select class="form-select" id="from_cur" name="from_cur">
              {% for currency in currencies %} {% if from_cur and
              from_cur==currency.code%}
              <option
                value="{{ currency.code }}"
                data-image="{{ url_for('static', filename='flags/' + currency.alpha_2_code.lower() + '.png') }}"
                selected
              >
                {{ currency.code }} - {{ currency.name }}
              </option>
              {% else %}
              <option
                value="{{ currency.code }}"
                data-image="{{ url_for('static', filename='flags/' + currency.alpha_2_code.lower() + '.png') }}"
              >
                {{ currency.code }} - {{ currency.name }}
              </option>
              {% endif %} {% endfor %}
            </select>
          </div>

          <div class="form-group col-2 text-center">
            <i
              class="fa-solid fa-arrow-right-arrow-left fa-lg cursor-pointer"
              id="exchange_icon"
            ></i>
          </div>

          <div class="form-group col-4 mx-auto" style="margin-bottom: 30px">
            <label for="to_cur" class="form-label">To Currency </label>
            <select class="form-select" id="to_cur" name="to_cur">
              {% for currency in currencies %} {% if to_cur and
              to_cur==currency.code%}
              <option
                value="{{ currency.code }}"
                data-image="{{ url_for('static', filename='flags/' + currency.alpha_2_code.lower() + '.png') }}"
                selected
              >
                {{ currency.code }} - {{ currency.name }}
              </option>
              {% else %}
              <option
                value="{{ currency.code }}"
                data-image="{{ url_for('static', filename='flags/' + currency.alpha_2_code.lower() + '.png') }}"
              >
                {{ currency.code }} - {{ currency.name }}
              </option>
              {% endif %} {% endfor %}
            </select>
          </div>
        </div>
        <div class="row justify-content-between align-items-center">
          <div class="form-group col-3" style="margin-bottom: 25px">
            <label for="duration" class="form-label">Duration </label>
            <select id="duration" name="duration" class="form-select">
              <option value="" disabled selected>Select Duration</option>
              <option value="7d">One Week</option>
              <option value="14d">Two Weeks</option>
              <option value="1m">One Month</option>
              <option value="3m">Three Months</option>
              <option value="6m">Six Months</option>
              <option value="1y">One Year</option>
              <option value="2y">Two Years</option>
              <option value="1h" disabled>Last Hour (Not Supported)</option>
              <option value="1d" disabled>One Day (Not Supported)</option>
            </select>
          </div>
          <a
            class="btn btn-primary square col-2 btn-sm"
            data-toggle="modal"
            data-target="#notification-modal"
          >
            <i
              class="fa-solid fa-bell"
              style="color: #ffffff; margin-right: 15px"
            ></i>
            Set Alert
          </a>
        </div>

      </form>

      {% include 'includes/exchange_rate_notification.html'%}

      <div
        class="row justify-content-between align-items-center"
        style="margin-bottom: 20px"
      >
        <div class="col-6">
          <span class="fw-bold" id="changes_label" style="display: none">
            Changes (<span id="currencies"></span>):
            <span id="changes_value"></span>
          </span>
        </div>
      </div>
      <canvas id="rsiChart" width="400" height="200"></canvas>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    function formatOption(option) {
      if (!option.id) {
        return option.text;
      }

      var imageUrl = $(option.element).data("image");
      if (!imageUrl) {
        return option.text;
      }

      return $(
        '<span><img src="' +
          imageUrl +
          '" class="img-flag" style="width:25px;height:15px;margin-right:5px"/> ' +
          option.text +
          "</span>"
      );
    }

    $("#from_cur").select2({
      theme: "bootstrap-5",
      templateResult: formatOption,
      templateSelection: formatOption,
      width: "100%",
    });

    $("#to_cur").select2({
      theme: "bootstrap-5",
      templateResult: formatOption,
      templateSelection: formatOption,
      width: "100%",
    });
    
    $('#duration').select2({
      placeholder: 'Select duration...',
      theme: "bootstrap-5",
      minimumResultsForSearch: Infinity,
      width: "100%"
    })

    $("#exchange_icon").click(function () {
      var from_cur = $("#from_cur").val();
      var to_cur = $("#to_cur").val();

      $("#from_cur").val(to_cur).trigger("change");
      $("#to_cur").val(from_cur).trigger("change");
    });

    $('#to_cur, #from_cur, #duration').change(function() {
      var fromCurValue = $('#from_cur').val();
      var toCurValue = $('#to_cur').val();
      var durationValue = $('#duration').val();
      if (fromCurValue != "" && toCurValue!="" && durationValue != "")
        $('#get_historical_form').submit();
    });

    $("#get_historical_form").submit(function (event) {
      event.preventDefault();

      var formData = $(this).serialize();

      $.ajax({
        url: "/currency/historical-rsi",
        type: "POST",
        data: formData,
        success: function (response) {
          console.log(response);
          var changes = response.changes;
          $("#changes_label").show();
          var from_cur = $("#from_cur").val();
          var to_cur = $("#to_cur").val();
          $("#currencies").text(from_cur + "/" + to_cur);
          if (changes > 0) {
            $("#changes_value").text("+" + changes + "%");
            $("#changes_value").css("color", "green");
          } else {
            $("#changes_value").text(changes + "%");
            $("#changes_value").css("color", "red");
          }

          var rsi_values = response.rsi_values;
          var dates = response.dates;
          console.log(rsi_values);
          console.log(dates);
          var dataset = {
            label: from_cur + "/" + to_cur + " RSI Values",
            data: rsi_values,
          };

          var parent = $("#rsiChart").parent();
          $("#rsiChart").remove();
          var newCanvas = $("<canvas>").attr("id", "rsiChart");
          parent.append(newCanvas);

          var rsiChart = new Chart(newCanvas, {
            type: "line",
            data: {
                labels: dates,
                datasets: [dataset],
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: false,
                        },
                    }],
                },
                plugins: {
                  annotation: {
                    annotations: {
                      line1: {
                        type: 'line',
                        yMin: 70,
                        yMax: 70,
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 2,
                        label:{
                          content: "Overbought",
                          position: 'end',
                          display: true
                        }
                      },
                      line2: {
                        type: 'line',
                        yMin: 30,
                        yMax: 30,
                        borderColor: 'green',
                        borderWidth: 2,
                        label:{
                          content: "Oversold",
                          position: 'end',
                          display: true
                        }
                      }
                    },
                  }
                }
            },
          });
        },
        error: function (xhr, status, error) {
          console.error(xhr.responseText);
        },
      });
    });
  });
</script>
{% endblock %}
