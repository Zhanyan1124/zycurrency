{% extends 'sidebar.html' %} {% block content %}
<div class="container-fluid">
  <h3 class="text-center" style="margin-bottom: 25px">
    Historical Exchange Rate Changes
  </h3>
  <div class="d-flex justify-content-center align-items-center">
    <div style="width: 70%">
      <form
        method="POST"
        action="/currency/historical-exrate"
        id="get_historical_form"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_exrate_token }}">
        <div
          class="row justify-content-between align-items-center"
          style="margin-bottom: 20px"
        >
          <div class="form-group col-4 mx-auto" >
            <label for="from_cur" class="form-label">From Currency </label>
            <select class="form-select" id="from_cur" name="from_cur">
              {% for currency in currencies %} {% if from_cur and
              from_cur==currency.code%}
              <option
                value="{{ currency.code }}"
                data-image="{{ url_for('static', filename='flags/' + currency.alpha_2_code.lower() + '.png') }}"
                selected
              >
                {{ currency.code }} - {{ currency.name }}
              </option>
              {% else %}
              <option
                value="{{ currency.code }}"
                data-image="{{ url_for('static', filename='flags/' + currency.alpha_2_code.lower() + '.png') }}"
              >
                {{ currency.code }} - {{ currency.name }}
              </option>
              {% endif %} {% endfor %}
            </select>
          </div>

          <div class="form-group col-2 text-center">
            <i
              class="fa-solid fa-arrow-right-arrow-left fa-lg cursor-pointer"
              id="exchange_icon"
            ></i>
          </div>

          <div class="form-group col-4 mx-auto">
            <label for="to_cur" class="form-label">To Currency </label>
            <select class="form-select" id="to_cur" name="to_cur">
              {% for currency in currencies %} {% if to_cur and
              to_cur==currency.code%}
              <option
                value="{{ currency.code }}"
                data-image="{{ url_for('static', filename='flags/' + currency.alpha_2_code.lower() + '.png') }}"
                selected
              >
                {{ currency.code }} - {{ currency.name }}
              </option>
              {% else %}
              <option
                value="{{ currency.code }}"
                data-image="{{ url_for('static', filename='flags/' + currency.alpha_2_code.lower() + '.png') }}"
              >
                {{ currency.code }} - {{ currency.name }}
              </option>
              {% endif %} {% endfor %}
            </select>
          </div>
        </div>
        <div class="row justify-content-between align-items-center">
          <div class="form-group col-3" style="margin-bottom: 25px">
            <label for="duration" class="form-label">Duration </label>
            <select id="duration" name="duration" class="form-select">
              <option value="7d" selected>One Week</option>
              <option value="14d">Two Weeks</option>
              <option value="1m">One Month</option>
              <option value="3m">Three Months</option>
              <option value="6m">Six Months</option>
              <option value="1y">One Year</option>
              <option value="2y">Two Years</option>
              <option value="1h" disabled>Last Hour (Not Supported)</option>
              <option value="1d" disabled>One Day (Not Supported)</option>
            </select>
          </div>
          <a
            class="btn btn-primary square col-2 btn-sm"
            data-toggle="modal"
            data-target="#alert-modal"
          >
            <i
              class="fa-solid fa-bell"
              style="color: #ffffff; margin-right: 15px"
            ></i>
            Set Alert
          </a>
        </div>

      </form>

      {% include 'includes/exchange_rate_alert.html'%}

      <div
        class="row justify-content-between align-items-center"
        style="margin-bottom: 20px"
      >
        <div class="col-6">
          <span class="fw-bold" id="changes_label" style="display: none">
            Changes (<span id="currencies"></span>):
            <span id="changes_value"></span>
          </span>
        </div>
      </div>
      <div id="exchangeChart"></div>

    </div>
  </div>
</div>

<script>
  function fillExRateChanges(changes){
    $("#changes_label").show();
    var from_cur = $("#from_cur").val();
    var to_cur = $("#to_cur").val();
    $("#currencies").text(from_cur + "/" + to_cur);
    if (changes > 0) {
      $("#changes_value").text("+" + changes + "%");
      $("#changes_value").css("color", "green");
    } else {
      $("#changes_value").text(changes + "%");
      $("#changes_value").css("color", "red");
    }
  }

  function convertObjectToList(objects){
    var data = objects;
    var currency = Object.keys(data)[0];

    var result = Object.entries(data[currency]).map(([date, value]) => [date, value]);
    return result;
  }

  /*
  function disableOptions() {
    var toCurValue = $('#to_cur').val();
    var fromCurValue = $('#from_cur').val();
    
    $("#from_cur option[value='" + toCurValue + "']").prop("disabled", true);
    $("#to_cur option[value='" + fromCurValue + "']").prop("disabled", true);
  }
  */

  $(document).ready(function () {
    //Define chart customizations
    var options = {
      chart: {
        height: 380,
        width: "100%",
        type: "line",
        animations: {
          initialAnimation: {
            enabled: false
          }
        },
        toolbar: {
          show: true,
          offsetX: 0,
          offsetY: 0,
          tools: {
            download: true,
            selection: false,
            zoom: false,
            zoomin: true,
            zoomout: true,
            pan: false, 
            reset:false
          },
          export: {
            csv: {
              filename: undefined,
              columnDelimiter: ',',
              headerCategory: 'category',
              headerValue: 'value',
              dateFormatter(timestamp) {
                return new Date(timestamp).toDateString()
              }
            },
            svg: {
              filename: undefined,
            },
            png: {
              filename: undefined,
            }
          },
          autoSelected: 'zoom' 
        },
      },
      stroke: {
        curve: 'smooth',
      },
      title: {
        text: $("#from_cur").val() + " / " + $("#to_cur").val() + " Historical Exchange Rates",
        align: 'center',
        margin: 10,
        offsetX: 0,
        offsetY: 0,
        floating: false,
        style: {
          fontSize:  '18px',
          fontWeight:  'bold',
          color:  '#263238'
        },
      },
      dataLabels: { 
        enabled: false
      },
      noData: {
        text: 'Requesting Data...'
      },
      series: [],
      xaxis: {
        type: "datetime"
      }
    };
    var chart = new ApexCharts(document.querySelector("#exchangeChart"), options);
    chart.render();

    //Send first ajax request when page initially load
    var formData = $("#get_historical_form").serialize();
    $.ajax({
      url: "/currency/historical-exrate",
      type: "POST",
      data: formData,
      success: function (response) {
        console.log(response);
        fillExRateChanges(response.changes)
        const chart_data = convertObjectToList(response.results)
        const latest_rate = chart_data[chart_data.length-1][1];
        $('#current_rate').text(latest_rate.toFixed(4));
        $('#current_rate_section').show();

        chart.updateSeries([{
          name: $("#from_cur").val() + " / " + $("#to_cur").val() + " Exchange Rate:",
          data: chart_data
        }])
        chart.updateOptions({
          title: {
            text: $("#from_cur").val() + " / " + $("#to_cur").val() + " Historical Exchange Rates",
          }
        })

      },
      error: function (xhr, status, error) {
        console.error(xhr.responseText);
      },
    });

    //Customize currency selection field
    function currencySelectionOption(option) {
      if (!option.id) {
        return option.text;
      }

      var imageUrl = $(option.element).data("image");
      if (!imageUrl) {
        return option.text;
      }

      return $(
        '<span><img src="' +
          imageUrl +
          '" class="img-flag" style="width:25px;height:15px;margin-right:5px"/> ' +
          option.text +
          "</span>"
      );
    }

    //Use Select2 package to define the select inputs
    $("#from_cur").select2({
      theme: "bootstrap-5",
      templateResult: currencySelectionOption,
      templateSelection: currencySelectionOption,
      width: "100%",
    });
    $("#to_cur").select2({
      theme: "bootstrap-5",
      templateResult: currencySelectionOption,
      templateSelection: currencySelectionOption,
      width: "100%",
    });
    $('#duration').select2({
      theme: "bootstrap-5",
      minimumResultsForSearch: Infinity,
      width: "100%"
    })

    //Swap button
    $("#exchange_icon").click(function () {
      var from_cur = $("#from_cur").val();
      var to_cur = $("#to_cur").val();
      //$("#from_cur option[value='" + toCurValue + "']").prop("disabled", false);
      $("#from_cur").val(to_cur).trigger("change");
      //$("#to_cur option[value='" + fromCurValue + "']").prop("disabled", false);
      $("#to_cur").val(from_cur).trigger("change");
      
    });

    // Block user from choosing same currency
    /*
    var toCurValue = $('#to_cur').val();
    $("#from_cur option[value='" + toCurValue + "']").prop("disabled", true);
    var fromCurValue = $('#from_cur').val();
    $("#to_cur option[value='" + fromCurValue + "']").prop("disabled", true);
    $('#to_cur').change(function() {
      var toCurValue = $('#to_cur').val();
      $("#from_cur option[value='" + toCurValue + "']").prop("disabled", true);
    })
    $('#from_cur').change(function() {
      var fromCurValue = $('#from_cur').val();
      $("#to_cur option[value='" + fromCurValue + "']").prop("disabled", true);
    })
    */

    //Submit the form when data changes
    $('#to_cur, #from_cur, #duration').change(function() {
      var fromCurValue = $('#from_cur').val();
      var toCurValue = $('#to_cur').val();
      var durationValue = $('#duration').val();
      if (fromCurValue != "" && toCurValue!="" && durationValue != "" && fromCurValue!=toCurValue)
        $('#get_historical_form').submit();
    });

    //Send ajax request when form submitted to update chart
    $("#get_historical_form").submit(function (event) {
      event.preventDefault();

      var formData = $(this).serialize();

      $.ajax({
        url: "/currency/historical-exrate",
        type: "POST",
        data: formData,
        success: function (response) {
          console.log(response);
          fillExRateChanges(response.changes);
          const chart_data = convertObjectToList(response.results);
          const latest_rate = chart_data[chart_data.length-1][1];
          $('#current_rate').text(latest_rate.toFixed(4));
          $('#current_rate_section').show();

          chart.updateSeries([{
            name: $("#from_cur").val() + " / " + $("#to_cur").val() + " Exchange Rate:",
            data: chart_data
          }])
          chart.updateOptions({
            title: {
              text: $("#from_cur").val() + " / " + $("#to_cur").val() + " Historical Exchange Rates",
            }
          })
        },
        error: function (xhr, status, error) {
          console.error(xhr.responseText);
        },
      });
    });
  });


</script>
{% endblock %}
