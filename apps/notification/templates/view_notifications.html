{% extends 'sidebar.html' %} {% block content %}
<div class="container-fluid">
  <h3 class="text-start" style="margin-bottom: 25px">Notification Setting</h3>
  <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4">
    {% for notification in notifications %}
    <div class="col">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span style="font-size:0.9rem">Exchange Rate</span>
          <span style="font-size:0.8rem; text-transform: capitalize; color:#4562FB; font-weight:bold">{{notification.alert_type}}</span>
        </div>
        <div class="card-body">
          <h6 class="card-title d-flex align-items-center justify-content-between">
            Notification
            <div class="form-check form-switch">
              <input class="form-check-input clickable-icon toggle_notification" type="checkbox" role="switch" data-notification-id="{{ notification.id }}" {% if notification.is_enabled %} checked {% endif %}>
            </div>
            <i class="fa-solid fa-wrench clickable-icon"></i>
            <i class="fa-solid fa-trash clickable-icon delete_notification" style="color: #fa0000;" data-notification-id="{{ notification.id }}"></i>
          </h6>
          {% if notification.alert_type == 'periodically'%}
          <p class="card-text" >Period: <span style='text-transform:capitalize; font-size:0.95rem' class="fw-bold px-1">{{notification.period}}</span></p>
          {% else %}
          <p class="card-text">Threshold: 
            <span class='fw-bold px-2' style='font-size:0.99rem'> 
              {% if notification.condition == 'more'%}
                More Than
              {% else %}
                Less Than
              {% endif %}
              {{notification.rate}}
            </span>
          </p>
          {% endif %}

          <div class="d-flex justify-content-start align-items-center mb-3">
            <img src="{{ url_for('static', filename='flags/' + notification.from_cur.alpha_2_code.lower() + '.png') }}" class="img-flag" style="width:25px;height:15px;margin-right:5px"/>
            {{notification.from_cur.code}}
            <i class="fa-solid fa-arrow-right mx-3"></i>
            <img src="{{ url_for('static', filename='flags/' + notification.to_cur.alpha_2_code.lower() + '.png') }}" class="img-flag" style="width:25px;height:15px;margin-right:5px"/>
            {{notification.to_cur.code}}
          </div>

          <div class='d-flex flex-column align-items-start justify-content-center'>
            <label for="notes" class="form-label">Notes:</label>
            <div class="d-flex align-items-center w-100">
              <div class="col-10"> 
                <textarea class="form-control form-control-sm" id="notes_{{notification.id}}" name="notes" rows="5" placeholder="Type something here..." disabled>{{notification.notes}}</textarea>
              </div>
              <div class="col-1">
                <i class="fa-solid fa-pencil clickable-icon mx-2 edit_notes" data-id="{{ notification.id }}" id="edit_icon_{{notification.id}}"></i>
                <i class="fa-solid fa-floppy-disk clickable-icon mx-2 save_notes" data-id="{{ notification.id }}" id="save_icon_{{notification.id}}" style="display: none;"></i>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
    {% endfor %}      
  </div>
</div>

<script>
  $(document).ready(function() {
    $('.delete_notification').click(function() {
      var notificationId = $(this).data('notification-id'); 
      var $card = $(this).closest('.card');
      $.ajax({
          url: '/notifications/delete/' + notificationId, 
          type: 'DELETE',
          success: function(response) {
            $card.remove();
            location.reload();
            alert(response.message);
            console.log(response);
          },
          error: function(xhr, status, error) {
            alert('Error: ' + xhr.responseText);
            console.error(xhr.responseText);
          }
      });
    });

    $('.toggle_notification').change(function() {
      var notificationId = $(this).data('notification-id'); 
      $.ajax({
          url: '/notifications/toggle/' + notificationId, 
          type: 'PUT',
          success: function(response) {
            console.log(response);
          },
          error: function(xhr, status, error) {
            console.error(xhr.responseText);
          }
      });
    });

    $('.edit_notes').click(function() {
      var notesId = $(this).data('id');
      var $notes = $('#notes_' + notesId);
      $notes.prop('disabled', false);
      $notes.focus();
      var $saveIcon = $('#save_icon_'+notesId)
      $saveIcon.show();
      $(this).hide();
    });

    
    $('.save_notes').click(function() {
      var notesId = $(this).data('id');
      var $notes = $('#notes_' + notesId);
      $notes.prop('disabled', true);
      var $editIcon = $('#edit_icon_'+notesId)
      $editIcon.show();
      $(this).hide();
      
      var notesContent = $notes.val(); 
      $.ajax({
        url: '/notifications/edit-notes/' + notesId, 
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ notes: notesContent }),
        success: function(response) {
          console.log(response);
        },
        error: function(xhr, status, error) {
          console.error(xhr.responseText);
        }
    });

    });
  });
</script>
{% endblock %}
